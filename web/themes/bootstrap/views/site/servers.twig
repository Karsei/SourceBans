    <div class="row">
    <section class="servers span12">
{% do this.widget('zii.widgets.grid.CGridView', {
	'id': 'servers-grid',
	'dataProvider': servers,
	'columns': [
		{
			'header': t('sourcebans', 'Game'),
			'headerHtmlOptions': {
				'class': 'icon',
			},
			'htmlOptions': {
				'class': 'icon',
			},
			'name': 'game.name',
			'type': 'html',
			'value': 'CHtml::image(Yii::app()->baseUrl . "/images/games/" . $data->game->icon, $data->game->name)',
		},
		{
			'header': 'OS',
			'headerHtmlOptions': {
				'class': 'ServerQuery_OS icon',
			},
			'htmlOptions': {
				'class': 'ServerQuery_OS icon',
			},
			'type': 'html',
			'value': 'CHtml::image(Yii::app()->theme->baseUrl . "/images/loading.gif", Yii::t("sourcebans", "N/A"))',
		},
		{
			'header': 'VAC',
			'headerHtmlOptions': {
				'class': 'ServerQuery_VAC icon',
			},
			'htmlOptions': {
				'class': 'ServerQuery_VAC icon',
			},
			'type': 'html',
			'value': 'CHtml::image(Yii::app()->theme->baseUrl . "/images/loading.gif", Yii::t("sourcebans", "N/A"))',
		},
		{
			'header': t('sourcebans', 'Hostname'),
			'headerHtmlOptions': {
				'class': 'ServerQuery_hostname',
			},
			'htmlOptions': {
				'class': 'ServerQuery_hostname',
			},
			'value': 'Yii::t("sourcebans", "components.ServerQuery.loading") . " (" . $data->ip . ":" . $data->port . ")"',
		},
		{
			'header': t('sourcebans', 'Players'),
			'headerHtmlOptions': {
				'class': 'ServerQuery_players',
			},
			'htmlOptions': {
				'class': 'ServerQuery_players',
			},
			'value': 'Yii::t("sourcebans", "N/A")',
		},
		{
			'header': t('sourcebans', 'Map'),
			'headerHtmlOptions': {
				'class': 'ServerQuery_map',
			},
			'htmlOptions': {
				'class': 'ServerQuery_map',
			},
			'value': 'Yii::t("sourcebans", "N/A")',
		},
	],
	'cssFile': false,
	'enablePagination': false,
	'enableSorting': false,
	'itemsCssClass': 'items table table-accordion table-condensed table-hover',
	'rowHtmlOptionsExpression': 'array(
		"class"=>"header",
		"data-key"=>$data->primaryKey,
		"data-game-folder"=>$data->game->folder,
		"data-rcon"=>!empty($data->rcon),
	)',
	'selectableRows': isDashboard is defined ? 1 : 0,
	'selectionChanged': 'js:function(grid) {
		var $header = $("#" + grid + " tr.selected");
		var id      = $header.data("key");
		
		location.href = "' ~ this.createUrl('site/servers', {'#': '__ID__'}) ~ '".replace("__ID__", id);
	}',
	'summaryText': false,
}) %}
    </section>
    </div>

{% if isDashboard is not defined %}
<script id="servers-section" type="text/x-template">
  <table class="table table-condensed table-hover pull-left" style="width: 430px">
    <thead>
      <tr>
        <th>{{ t('sourcebans', 'Name') }}</th>
        <th class="nowrap text-right">{{ t('sourcebans', 'Score') }}</th>
        <th class="nowrap">{{ t('sourcebans', 'Time') }}</th>
      </tr>
    </thead>
    <tbody>
<% if(server.players.length) { %>
<% $.each(server.players, function(i, player) { %>
      <tr class="player" data-name="<%=player.name %>">
        <td><%=player.name %></td>
        <td class="text-right"><%=player.score %></td>
        <td class="nowrap"><%=player.time %></td>
      </tr>
<% }); %>
<% } else { %>
      <tr>
        <td class="text-center" colspan="3"><em>{{ t('sourcebans', 'No players in the server') }}</em></td>
      </tr>
<% } %>
    </tbody>
  </table>
  <div class="pull-right">
    <img alt="<%=(server.error ? "{{ t('sourcebans', 'Unknown') }}" : server.map) %>" class="map-image img-rounded" src="<%=(server.error || !server.map_image ? "{{ App.baseUrl }}/images/maps/unknown.jpg" : server.map_image) %>" />
    <div class="well text-center">
      <p><%=server.ip %>:<%=server.port %></p>
      <a class="btn btn-success" href="steam://connect/<%=server.ip %>:<%=server.port %>">{{ t('sourcebans', 'Join game') }}</a>
      <a class="btn btn-info" href="javascript:queryServer(<%=server.id %>)">{{ t('sourcebans', 'Refresh') }}</a>
    </div>
  </div>
</script>

{% do App.clientScript.registerScript('site_servers_hashchange', '
  $(window).bind("hashchange", function(e) {
    $("#servers-grid > table.table-accordion > tbody > tr.selected").removeClass("selected");
    $("#servers-grid tr.section div:first-child").slideUp(200, "linear");
    
    var id      = $.param.fragment();
    var $header = $("#servers-grid tr[data-key=\\"" + id + "\\"]");
    if(!$header.length)
      return;
    
    var $section = $header.next("tr.section");
    $header.addClass("selected");
    $section.find("div:first-child").slideDown(200, "linear");
  });
  
  $(document).on("click.yiiGridView", "#servers-grid tr.header", function(e) {
    var $this     = $(this);
    location.hash = $this.hasClass("selected") ? 0 : $this.data("key");
  });
') %}

{% if not App.user.isGuest %}
{% do this.widget('bootstrap.widgets.TbDropdown', {
	'id': 'player-menu',
	'items': [
		{
			'itemOptions': {'class': 'player-name'},
		},
		{
			'label': t('sourcebans', 'Kick player'),
			'url': '#',
			'linkOptions': {'id': 'player-kick'},
			'visible': App.user.data.hasFlag(constant('SM_KICK')),
		},
		{
			'label': t('sourcebans', 'Ban player'),
			'url': '#',
			'linkOptions': {'id': 'player-ban'},
			'visible': App.user.data.hasPermission('ADD_BANS'),
		},
		{
			'divider': true,
		},
		{
			'label': t('sourcebans', 'View Steam Profile'),
			'url': '#',
			'itemOptions': {'class': 'rcon'},
			'linkOptions': {'id': 'player-profile'},
		},
	]|merge(this.menu),
}) %}

{% do App.clientScript.registerScript('site_servers_playerMenu', '
  $(document).on("click", function() {
    $("#player-menu").hide();
  });
  $(document).on("contextmenu", "#servers-grid .player", function(e) {
    e.preventDefault();
    var name = $(this).data("name");
    var rcon = $("#servers-grid tr.selected").data("rcon");
    
    $("#player-menu .player-name").text(name);
    $("#player-menu li.rcon").toggleClass("disabled", !rcon);
    $("#player-menu")
      .data("name", name)
      .css({
        top: event.pageY - 12,
        left: event.pageX + 2
      })
      .show();
  });
  
  $("#player-profile").click(function() {
    if($(this).parents("li").hasClass("disabled"))
      return;
    
    var id = $("#servers-grid tr.selected").data("key");
    
    $.post("' ~ this.createUrl('servers/getProfile', {'id': '__ID__'}) ~ '".replace("__ID__", id), {
      name: $("#player-menu").data("name")
    }, function(data) {
      if(data.error)
        return;
      
      location.href = "http://steamcommunity.com/profiles/" + data.id;
    }, "json");
  });
  
  $("#player-kick").click(function() {
    var id = $("#servers-grid tr.selected").data("key");
    if(!confirm("' ~ t('sourcebans', 'Are you sure you want to kick {name}?') ~ '".replace("{name}", $("#player-menu").data("name"))))
	    return;
    
    $.post("' ~ this.createUrl('servers/kick', {'id': '__ID__'}) ~ '".replace("__ID__", id), {
      name: $("#player-menu").data("name")
    }, function() {
      queryServer(id);
    });
  });
') %}
{% endif %}
{% endif %}

{% do App.clientScript.registerScript('site_servers_queryServer', '
  function queryServer(id, callback) {
    if(typeof(id) == "function") {
      callback = id;
      id = 0;
    }
    else {
      id = id || 0;
    }
    
    $.getJSON("' ~ this.createUrl(isDashboard is defined ? 'servers/info' : 'servers/query', {'id': '__ID__'}) ~ '".replace("__ID__", id), function(servers) {
      if(!$.isArray(servers)) {
        servers = [servers];
      }
      
      $.each(servers, function(i, server) {
        var $header = $("#servers-grid tr[data-key=\\"" + server.id + "\\"]");
        $header.find(".ServerQuery_OS").html(server.error ? "' ~ t('sourcebans', 'N/A') ~ '" : "<img src=\\"' ~ App.baseUrl ~ '/images/os_" + server.os + ".png\\" alt=\\"" + (server.os == "w" ? "Windows" : "Linux") + "\\" />");
        $header.find(".ServerQuery_VAC").html(server.error || !server.secure ? "' ~ t('sourcebans', 'N/A') ~ '" : "<img src=\\"' ~ App.baseUrl ~ '/images/secure.png\\" alt=\\"Valve Anti-Cheat\\" />");
        $header.find(".ServerQuery_hostname").html(server.error ? server.error.message : server.hostname);
        $header.find(".ServerQuery_map").text(server.error ? "' ~ t('sourcebans', 'N/A') ~ '" : server.map);
        $header.find(".ServerQuery_players").text(server.error ? "' ~ t('sourcebans', 'N/A') ~ '" : server.numplayers + "/" + server.maxplayers);
        
        if(server.players) {
          var $section = $header.next("tr.section");
          if(!$section.length) {
            $section = $("<tr class=\\"section\\"><td colspan=\\"" + $header[0].cells.length + "\\"><div></div></td></tr>").insertAfter($header);
          }
          
          $section.find("div").html($("#servers-section").template({
            server: server,
          }));
        }
        
        // Store server information in header
        if(!server.error) {
          $header.data({
            map: server.map,
            maxplayers: server.maxplayers,
            numplayers: server.numplayers,
            os: server.os,
            secure: server.secure
          });
        }
        
        if(typeof(callback) == "function") {
          callback(server.id);
        }
      });
      
      if(!id && typeof(callback) == "function") {
        callback();
      }
    });
  }
  
  $("#servers-grid tr[data-key]").each(function() {
    var id = $(this).data("key");
    
    queryServer(id, function(id) {
      // If all servers are queried
      if(!id || id == $.param.fragment()) {
        $(window).trigger("hashchange");
      }
    });
  });
') %}